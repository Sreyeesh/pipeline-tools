services:
  pipely:
    image: pipely:latest
    build: .
    working_dir: /app
    volumes:
      - ${PROJECTS_ROOT:-/mnt/c/Projects}:/mnt/c/Projects
      - ${DB_VOLUME:-pipely-db}:/root/.pipeline_tools
    entrypoint: ["python", "-m", "pipeline_tools.cli"]
    command: ["--list"]

  pipely-test:
    image: pipely:builder
    build:
      context: .
      target: builder
    working_dir: /app
    volumes:
      - ./:/app
    entrypoint: ["/bin/sh", "-c"]
    command: ["pytest"]

  pipely-shell:
    image: pipely-dev:latest
    build:
      context: .
      dockerfile: Dockerfile.dev
    working_dir: /app
    volumes:
      - ${PROJECTS_ROOT:-/mnt/c/Projects}:/mnt/c/Projects
      - ${DB_VOLUME:-pipely-db}:/root/.pipeline_tools
      - ./:/app
    entrypoint: ["/bin/bash", "-lc", "pip install -e . && pip install -r requirements-dev.txt && exec bash"]

volumes:
  pipely-db:
    name: ${DB_VOLUME:-pipely-db}
