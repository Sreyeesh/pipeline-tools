---
- name: Build and publish GitHub release assets (main branch only)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    repo: "<your-org>/pipeline-tools"  # override with -e repo=org/name
    version: ""                        # required: tag like v0.1.1
    api_root: "https://api.github.com/repos/{{ repo }}"
    python_bin: "{{ ansible_playbook_python | default('python3') }}"
    repo_root: "{{ playbook_dir | dirname }}"
    allow_non_monday: false            # set to true to bypass Monday-only gate (e.g., hotfixes)
    package_name: "pipely"
    dist_whl: "{{ repo_root }}/dist/{{ package_name }}-{{ version | regex_replace('^v','') }}-py3-none-any.whl"
    dist_sdist: "{{ repo_root }}/dist/{{ package_name }}-{{ version | regex_replace('^v','') }}.tar.gz"

  pre_tasks:
    - name: Ensure version tag is provided
      ansible.builtin.fail:
        msg: "Set -e version=vX.Y.Z"
      when: version == ""

    - name: Check if today is Monday
      ansible.builtin.command: date -u +%u
      register: day_of_week
      changed_when: false

    - name: Abort if not Monday
      ansible.builtin.fail:
        msg: "Releases can only be published on Mondays (UTC). Today is day {{ day_of_week.stdout }} (1=Monday, 7=Sunday)."
      when:
        - day_of_week.stdout != "1"
        - not allow_non_monday

    - name: Verify current branch is main
      ansible.builtin.command: git rev-parse --abbrev-ref HEAD
      register: branch
      changed_when: false
    - name: Abort if not on main
      ansible.builtin.fail:
        msg: "Release must be run from main; current branch is {{ branch.stdout }}"
      when: branch.stdout != "main"

    - name: Update pip and install build deps
      ansible.builtin.command: "{{ python_bin }} -m pip install --upgrade pip"
      args:
        chdir: "{{ repo_root }}"
    - name: Install dev/build deps
      ansible.builtin.command: "{{ python_bin }} -m pip install -r requirements-dev.txt build twine"
      args:
        chdir: "{{ repo_root }}"

    - name: Ensure dist directory is clean
      ansible.builtin.file:
        path: "{{ repo_root }}/dist"
        state: absent
      changed_when: false

  tasks:
    - name: Run tests
      ansible.builtin.command: "{{ python_bin }} -m pytest"
      args:
        chdir: "{{ repo_root }}"

    - name: Build artifacts
      ansible.builtin.command: "{{ python_bin }} -m build"
      args:
        chdir: "{{ repo_root }}"

    - name: Look up existing release by tag
      ansible.builtin.uri:
        url: "{{ api_root }}/releases/tags/{{ version }}"
        headers:
          Authorization: "Bearer {{ lookup('env', 'GITHUB_TOKEN') }}"
          Accept: "application/vnd.github+json"
        return_content: true
        status_code: [200, 404]
      register: release_lookup

    - name: Create release when missing
      ansible.builtin.uri:
        url: "{{ api_root }}/releases"
        method: POST
        headers:
          Authorization: "Bearer {{ lookup('env', 'GITHUB_TOKEN') }}"
          Accept: "application/vnd.github+json"
        body_format: json
        body:
          tag_name: "{{ version }}"
          name: "{{ version }}"
          draft: false
          prerelease: false
        status_code: 201
        return_content: true
      when: release_lookup.status == 404
      register: release_create

    - name: Set upload URL
      ansible.builtin.set_fact:
        upload_url: >-
          {{
            (release_lookup.json.upload_url if release_lookup.status == 200 else release_create.json.upload_url)
            | regex_replace('\{\?name,label\}', '')
          }}

    - name: Upload wheel
      ansible.builtin.uri:
        url: "{{ upload_url }}?name={{ package_name }}-{{ version | regex_replace('^v','') }}-py3-none-any.whl"
        method: POST
        headers:
          Authorization: "Bearer {{ lookup('env', 'GITHUB_TOKEN') }}"
          Content-Type: "application/octet-stream"
          Accept: "application/vnd.github+json"
        src: "{{ dist_whl }}"
        status_code: [201, 422]

    - name: Upload sdist
      ansible.builtin.uri:
        url: "{{ upload_url }}?name={{ package_name }}-{{ version | regex_replace('^v','') }}.tar.gz"
        method: POST
        headers:
          Authorization: "Bearer {{ lookup('env', 'GITHUB_TOKEN') }}"
          Content-Type: "application/octet-stream"
          Accept: "application/vnd.github+json"
        src: "{{ dist_sdist }}"
        status_code: [201, 422]
