---
- name: Build the Pipely Docker image and run a smoke test
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    pipeline_tools_src: "{{ playbook_dir | dirname }}"
    pipely_image_name: "{{ pipely_image | default('pipely-loop') }}"
    pipely_smoke_test: true
    pipely_install_local: false
    pipely_install_mode: user
    pipely_install_python: /usr/bin/python3

  tasks:
    - name: Ensure Docker CLI is available
      ansible.builtin.command: docker --version
      changed_when: false

    - name: Build Pipely Docker image
      ansible.builtin.command: >
        docker build -t {{ pipely_image_name }} {{ pipeline_tools_src }}
      args:
        chdir: "{{ pipeline_tools_src }}"
      register: pipely_build
      changed_when: true

    - name: Show Docker build output
      ansible.builtin.debug:
        msg: "{{ pipely_build.stdout_lines }}"
      when: pipely_build.stdout is defined

    - name: Run smoke test inside the container
      ansible.builtin.command: >
        docker run --rm {{ pipely_image_name }} python -m pipeline_tools.cli --version
      args:
        chdir: "{{ pipeline_tools_src }}"
      when: pipely_smoke_test | bool

    - name: Install editable Pipely + dev deps and run tests in dev shell container
      # Build pipely-shell before running to pick up Dockerfile changes
      ansible.builtin.command: >
        docker compose -f docker-compose.yml build pipely-shell
      args:
        chdir: "{{ pipeline_tools_src }}"

    - name: Bootstrap dev shell (pip install + pytest)
      ansible.builtin.command: >
        docker compose -f docker-compose.yml run --rm pipely-shell bash -lc "pip install -e . && pip install -r requirements-dev.txt && python -m pytest"
      args:
        chdir: "{{ pipeline_tools_src }}"

    - name: Ensure Python is available for local install
      ansible.builtin.command: "{{ pipely_install_python }} --version"
      changed_when: false
      when: pipely_install_local | bool

    - name: Install Pipely locally without a venv
      ansible.builtin.command: >
        {{ pipely_install_python }} -m pip install
        {{ '--user' if pipely_install_mode == 'user' else '' }}
        {{ pipeline_tools_src }}
      args:
        chdir: "{{ pipeline_tools_src }}"
      environment:
        VIRTUAL_ENV: ""
        PATH: "/usr/bin:/bin:/usr/sbin:/sbin"
      when: pipely_install_local | bool
      become: "{{ pipely_install_mode == 'system' }}"
