---
- name: Install pipeline-tools for end users (pipx by default)
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    pipeline_tools_src: "{{ playbook_dir | dirname }}"
    pipeline_tools_installer: pipx  # options: pipx, pip
    pipeline_tools_python: python3
    pipeline_tools_manage_system_packages: true  # set false to skip apt tasks when sudo is unavailable
    pipeline_tools_can_sudo: true

  pre_tasks:
    - name: Check sudo availability for system package installs
      become: true
      ansible.builtin.command: "true"
      register: sudo_check
      failed_when: false
      changed_when: false
      when: pipeline_tools_manage_system_packages

    - name: Disable system package installs when sudo is not available
      set_fact:
        pipeline_tools_can_sudo: false
      when:
        - pipeline_tools_manage_system_packages
        - sudo_check is defined
        - sudo_check.rc is defined
        - sudo_check.rc != 0

    - name: Note when skipping system package installs
      debug:
        msg: "Skipping system package installs (set pipeline_tools_manage_system_packages=false or provide sudo with -K)."
      when:
        - not pipeline_tools_can_sudo
        - pipeline_tools_manage_system_packages

  tasks:
    - name: Ensure Python packaging tools are present (Debian/Ubuntu)
      become: true
      apt:
        name:
          - python3-pip
          - python3-venv
        state: present
        update_cache: true
      when:
        - ansible_os_family == "Debian"
        - pipeline_tools_manage_system_packages
        - pipeline_tools_can_sudo

    - name: Ensure pipx is installed via apt (Debian/Ubuntu)
      become: true
      apt:
        name: python3-pipx
        state: present
        update_cache: false
      register: pipx_apt
      failed_when: false
      when:
        - ansible_os_family == "Debian"
        - pipeline_tools_installer == "pipx"
        - pipeline_tools_manage_system_packages
        - pipeline_tools_can_sudo

    - name: Ensure pipx is installed for the user
      ansible.builtin.command: >
        {{ pipeline_tools_python }} -m pip install --user --upgrade pipx
      when:
        - pipeline_tools_installer == "pipx"
        - pipx_apt is not defined
          or (pipx_apt is defined and (pipx_apt is failed or pipx_apt is skipped))

    - name: Add pipx to PATH for this run
      set_fact:
        pipeline_tools_env:
          PATH: "{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
      when: pipeline_tools_installer == "pipx"

    - name: Install pipeline-tools via pipx
      environment: "{{ pipeline_tools_env | default({}) }}"
      command: >
        pipx install --force "{{ pipeline_tools_src }}"
      when: pipeline_tools_installer == "pipx"

    - name: Install pipeline-tools via pip (user site)
      ansible.builtin.command: >
        {{ pipeline_tools_python }} -m pip install --user --upgrade "{{ pipeline_tools_src }}"
      when: pipeline_tools_installer == "pip"

    - name: Show next steps for PATH (pipx)
      debug:
        msg: >
          pipeline-tools installed via pipx. If the command is not found, add {{ ansible_env.HOME }}/.local/bin to PATH.
      when: pipeline_tools_installer == "pipx"

    - name: Show next steps for PATH (pip)
      debug:
        msg: >
          pipeline-tools installed via pip --user. If the command is not found, add {{ ansible_env.HOME }}/.local/bin to PATH.
      when: pipeline_tools_installer == "pip"
