---
- name: Install pipeline-tools for end users (pipx by default)
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    pipeline_tools_src: "{{ playbook_dir | dirname }}"
    pipeline_tools_installer: pipx  # options: pipx, pip
    pipeline_tools_python: python3

  tasks:
    - name: Ensure Python packaging tools are present (Debian/Ubuntu)
      become: true
      apt:
        name:
          - python3-pip
          - python3-venv
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Ensure pipx is installed via apt (Debian/Ubuntu)
      become: true
      apt:
        name: python3-pipx
        state: present
        update_cache: false
      register: pipx_apt
      failed_when: false
      when:
        - ansible_os_family == "Debian"
        - pipeline_tools_installer == "pipx"

    - name: Ensure pipx is installed for the user
      ansible.builtin.command: >
        {{ pipeline_tools_python }} -m pip install --user --upgrade pipx
      when:
        - pipeline_tools_installer == "pipx"
        - pipx_apt is not defined
          or (pipx_apt is defined and (pipx_apt is failed or pipx_apt is skipped))

    - name: Add pipx to PATH for this run
      set_fact:
        pipeline_tools_env:
          PATH: "{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
      when: pipeline_tools_installer == "pipx"

    - name: Install pipeline-tools via pipx
      environment: "{{ pipeline_tools_env | default({}) }}"
      command: >
        pipx install --force "{{ pipeline_tools_src }}"
      when: pipeline_tools_installer == "pipx"

    - name: Install pipeline-tools via pip (user site)
      ansible.builtin.command: >
        {{ pipeline_tools_python }} -m pip install --user --upgrade "{{ pipeline_tools_src }}"
      when: pipeline_tools_installer == "pip"

    - name: Show next steps for PATH (pipx)
      debug:
        msg: >
          pipeline-tools installed via pipx. If the command is not found, add {{ ansible_env.HOME }}/.local/bin to PATH.
      when: pipeline_tools_installer == "pipx"

    - name: Show next steps for PATH (pip)
      debug:
        msg: >
          pipeline-tools installed via pip --user. If the command is not found, add {{ ansible_env.HOME }}/.local/bin to PATH.
      when: pipeline_tools_installer == "pip"
