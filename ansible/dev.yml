---
- name: Developer setup for pipeline-tools
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    repo_root: "{{ playbook_dir | dirname }}"
    python_bin: "{{ ansible_playbook_python | default('python3') }}"

  tasks:
    - name: Ensure base packages (Debian/Ubuntu)
      become: true
      apt:
        name:
          - python3-pip
          - build-essential
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Upgrade pip
      ansible.builtin.command: >
        {{ python_bin }} -m pip install --upgrade pip
      args:
        chdir: "{{ repo_root }}"

    - name: Install package in editable mode
      ansible.builtin.command: >
        {{ python_bin }} -m pip install -e .
      args:
        chdir: "{{ repo_root }}"

    - name: Install dev requirements
      ansible.builtin.command: >
        {{ python_bin }} -m pip install -r requirements-dev.txt
      args:
        chdir: "{{ repo_root }}"

    - name: Write sample .env for observability
      ansible.builtin.copy:
        dest: "{{ repo_root }}/.env"
        content: |
          # Observability defaults for local runs
          PIPELINE_TOOLS_METRICS=
          PIPELINE_TOOLS_REQUEST_ID=
          PIPELINE_TOOLS_DB=
          PIPELINE_TOOLS_ROOT=
      when: ansible_os_family != "Windows"
